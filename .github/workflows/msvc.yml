name: C/C++ CI

on: [push, pull_request]

jobs:
  build:

    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Update submodules 
      run: |
        git submodule update --init --recursive
      shell: cmd
      
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      
    - name: Build x86
      run: msbuild proxychains.exe.sln /p:Configuration=Release /p:Platform=x86 /p:PlatformToolset=v142 /p:WindowsTargetPlatformVersion=10.0
      shell: cmd

    - name: Build x64 (with embedded DLLs)
      run: msbuild proxychains.exe.sln /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v142 /p:WindowsTargetPlatformVersion=10.0 /p:EmbedDlls=true
      shell: cmd
    
    - name: Prepare release package
      run: |
        mkdir release-package
        copy win32_output\proxychains_win32_x64.exe release-package\proxychains.exe
        copy win32_output\proxychains_hook_x64.dll release-package\
        copy win32_output\proxychains_hook_x86.dll release-package\
        copy win32_output\proxychains_helper_win32_x86.exe release-package\
        copy win32_output\proxychains_helper_win32_x64.exe release-package\
        if exist win32_output\MinHook.x64.dll copy win32_output\MinHook.x64.dll release-package\
        if exist win32_output\MinHook.x86.dll copy win32_output\MinHook.x86.dll release-package\
        copy proxychains.conf release-package\
        copy PACKAGE_README.md release-package\README.txt
        copy README.md release-package\
        copy CHANGELOG.md release-package\
        copy TESTING.md release-package\
        copy COPYING release-package\
      shell: cmd
      
    - name: Upload artifact
      uses: actions/upload-artifact@v5
      with:
        name: proxychains-windows-unified
        path: release-package/
        retention-days: 90

